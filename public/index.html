<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Vampir KÃ¶ylÃ¼: Pro Edition</title>
    <style>
        :root { --primary: #4ecca3; --danger: #ff4b5c; --bg: #1a1c2c; --card: #2f357d; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; height: 100vh; overflow: hidden; }
        
        #game-container { width: 100%; max-width: 900px; display: grid; grid-template-columns: 250px 1fr 250px; gap: 10px; padding: 10px; }
        
        /* Paneller */
        .panel { background: rgba(0,0,0,0.3); border-radius: 15px; padding: 15px; display: flex; flex-direction: column; border: 1px solid rgba(255,255,255,0.1); }
        .scroll { overflow-y: auto; flex: 1; }
        
        /* Oyuncu KartlarÄ± */
        .p-card { background: var(--card); padding: 10px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid var(--primary); transition: 0.2s; }
        .p-card.dead { opacity: 0.4; filter: grayscale(1); border-left-color: #555; }
        .p-card:hover { transform: scale(1.02); }
        
        /* Chat & Log */
        #log { font-size: 11px; color: #bbb; border-bottom: 1px solid #444; margin-bottom: 5px; padding-bottom: 5px; }
        #chat { font-size: 13px; }
        .msg { margin-bottom: 4px; border-radius: 4px; padding: 2px 5px; }

        /* Timer ve Status */
        #status-area { grid-column: 1 / 4; background: var(--card); padding: 10px; border-radius: 12px; text-align: center; }
        .timer { font-size: 28px; font-weight: bold; color: #f9d423; }

        /* Kontroller */
        .controls { display: flex; gap: 5px; margin-top: 5px; }
        input { background: #222; border: 1px solid #444; color: white; padding: 8px; border-radius: 5px; flex: 1; }
        button { background: var(--primary); color: var(--bg); border: none; padding: 8px 15px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        button:disabled { background: #555; }

        /* Modallar */
        #modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; z-index: 100; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        
        .vampire-only { border: 1px solid var(--danger) !important; box-shadow: 0 0 10px rgba(255,75,92,0.2); }
    </style>
</head>
<body>

    <div id="setup" style="position:fixed; z-index:200; background:var(--bg); width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <h1 style="color:var(--primary); font-size: 3rem;">VAMPÄ°R KÃ–YLÃœ</h1>
        <input type="text" id="nameInp" placeholder="Efsanevi adÄ±nÄ± yaz..." style="font-size: 1.5rem; padding: 15px; width: 300px;">
        <br>
        <button onclick="join()" style="font-size: 1.5rem; padding: 15px 40px;">KÃ–YE GÄ°RÄ°Åž YAP</button>
    </div>

    <div id="game-container">
        <div id="status-area">
            <div id="status-msg">Lobi bekleniyor... En az 4 kiÅŸi gerekli.</div>
            <div id="timer" class="timer">--</div>
            <button id="start-btn" onclick="socket.emit('startGame')">OYUNU BAÅžLAT</button>
        </div>

        <div class="panel">
            <h3>KÃ¶y HalkÄ±</h3>
            <div id="player-list" class="scroll"></div>
        </div>

        <div class="panel">
            <div id="log" class="scroll"></div>
            <div id="chat" class="scroll"></div>
            <div class="controls">
                <input type="text" id="chatInp" placeholder="Mesaj yaz veya oyuncuya tÄ±kla fÄ±sÄ±lda...">
                <button onclick="sendMsg()">GÃ–NDER</button>
            </div>
            <div id="vampire-controls" style="display:none; margin-top:5px;">
                <button onclick="toggleVampireChat()" id="v-btn" style="background:var(--danger); color:white; width:100%;">VAMPÄ°R KONSEYÄ°: KAPALI</button>
            </div>
            <button id="finish-night-btn" onclick="socket.emit('finishNight')" style="display:none; margin-top:5px; background:orange;">GECEYÄ° BÄ°TÄ°R (YÃ¶netici)</button>
        </div>

        <div class="panel">
            <h3>Bilgilerim</h3>
            <div id="my-info" style="background:rgba(255,255,255,0.1); padding:10px; border-radius:10px;">
                <div id="my-role" style="font-size: 1.2rem; font-weight:bold;">Rol: ?</div>
                <hr>
                <small>Ä°pucu: Geceleri rolÃ¼ne gÃ¶re oyuncu kartlarÄ±ndaki butonlarÄ± kullan!</small>
            </div>
            <h3 style="margin-top:20px;">Ã–zel GÃ¶revler</h3>
            <div id="quests" style="font-size:0.8rem; color:#888;">HenÃ¼z gÃ¶rev yok.</div>
        </div>
    </div>

    <div id="modal">
        <h1 id="modal-title" style="color:var(--primary); font-size: 4rem;">OYUN BÄ°TTÄ°</h1>
        <div id="modal-content" style="max-width: 600px; font-size: 1.2rem;"></div>
        <br>
        <button onclick="location.reload()">LOBÄ°YE DÃ–N</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myRole = "";
        let isVChat = false;
        let selectedTargetId = null;

        function join() {
            const n = document.getElementById('nameInp').value;
            if(n) {
                socket.emit('joinGame', n);
                document.getElementById('setup').style.display = 'none';
            }
        }

        function sendMsg() {
            const inp = document.getElementById('chatInp');
            if(inp.value) {
                socket.emit('sendMessage', { 
                    text: inp.value, 
                    type: isVChat ? 'vampire' : 'global',
                    targetId: selectedTargetId 
                });
                inp.value = "";
                selectedTargetId = null;
                inp.placeholder = "Mesaj yaz...";
            }
        }

        function toggleVampireChat() {
            isVChat = !isVChat;
            document.getElementById('v-btn').innerText = isVChat ? "VAMPÄ°R KONSEYÄ°: AÃ‡IK" : "VAMPÄ°R KONSEYÄ°: KAPALI";
        }

        socket.on('assignRole', r => {
            myRole = r;
            document.getElementById('my-role').innerText = "RolÃ¼n: " + r;
            document.getElementById('my-role').style.color = (r === 'Vampir') ? '#ff4b5c' : '#4ecca3';
            if(r === 'Vampir') document.getElementById('vampire-controls').style.display = 'block';
            document.getElementById('start-btn').style.display = 'none';
            
            // Sadece yÃ¶neticiye geceyi bitirme yetkisi (simÃ¼lasyon)
            document.getElementById('finish-night-btn').style.display = 'block';
        });

        socket.on('gameUpdate', data => {
            document.body.style.background = (data.state === 'night') ? '#070914' : '#1a1c2c';
            document.getElementById('status-msg').innerText = data.message;
            
            const list = document.getElementById('player-list');
            list.innerHTML = "";
            data.players.forEach(p => {
                const card = document.createElement('div');
                card.className = `p-card ${p.alive ? '' : 'dead'}`;
                card.innerHTML = `<strong>${p.name}</strong>`;
                
                if(p.alive && p.id !== socket.id) {
                    const btnArea = document.createElement('div');
                    btnArea.className = "controls";
                    
                    const actionBtn = document.createElement('button');
                    if(data.state === 'night') {
                        if(myRole === 'Vampir') actionBtn.innerText = "SaldÄ±r";
                        else if(myRole === 'Doktor') actionBtn.innerText = "Koru";
                        else if(myRole === 'Kahin') actionBtn.innerText = "GÃ¶rÃ¼ Al";
                        
                        actionBtn.onclick = () => socket.emit('nightAction', { targetId: p.id });
                        if(['Vampir', 'Doktor', 'Kahin'].includes(myRole)) btnArea.appendChild(actionBtn);
                    } else {
                        actionBtn.innerText = "OYLA";
                        actionBtn.onclick = () => socket.emit('castVote', p.id);
                        btnArea.appendChild(actionBtn);
                    }
                    
                    const whisperBtn = document.createElement('button');
                    whisperBtn.innerText = "ðŸ’¬";
                    whisperBtn.style.background = "#777";
                    whisperBtn.onclick = () => {
                        selectedTargetId = p.id;
                        document.getElementById('chatInp').placeholder = `${p.name} kiÅŸisine fÄ±sÄ±lda...`;
                        document.getElementById('chatInp').focus();
                    };
                    btnArea.appendChild(whisperBtn);
                    
                    card.appendChild(btnArea);
                }
                list.appendChild(card);
            });
        });

        socket.on('receiveMessage', d => {
            const c = document.getElementById('chat');
            c.innerHTML += `<div class="msg" style="color:${d.color}"><b>${d.name}:</b> ${d.text}</div>`;
            c.scrollTop = c.scrollHeight;
        });

        socket.on('announcement', m => {
            const log = document.getElementById('log');
            log.innerHTML += `<div>ðŸ”” ${m}</div>`;
            log.scrollTop = log.scrollHeight;
        });

        socket.on('timerUpdate', t => { document.getElementById('timer').innerText = t > 0 ? t : "--"; });

        socket.on('gameOver', data => {
            const modal = document.getElementById('modal');
            const content = document.getElementById('modal-content');
            modal.style.display = "flex";
            document.getElementById('modal-title').innerText = data.winner + " KAZANDI!";
            
            let html = "<h3>Oyun GÃ¼nlÃ¼ÄŸÃ¼</h3><div style='text-align:left; font-size:0.9rem;'>";
            data.logs.forEach(l => html += `<li>${l}</li>`);
            html += "</div><h3>Roller</h3>";
            data.stats.forEach(s => html += `${s.name}: <b>${s.role}</b> | `);
            content.innerHTML = html;
        });

        socket.on('reload', () => location.reload());
        document.getElementById('chatInp').addEventListener('keypress', e => { if(e.key === 'Enter') sendMsg(); });
    </script>
</body>
</html>