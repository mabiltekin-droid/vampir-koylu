<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Vampir Köylü 3D: Pro Max</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; color: white; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        
        /* HUDs */
        .hud { pointer-events: auto; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; border: 1px solid #4ecca3; }
        #setup { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        #top-bar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); text-align: center; min-width: 300px; }
        
        /* Chat */
        #chat-area { position: absolute; left: 20px; bottom: 150px; width: 280px; height: 200px; display: flex; flex-direction: column; }
        #messages { flex: 1; overflow-y: auto; background: rgba(0,0,0,0.5); padding: 5px; font-size: 0.8rem; border-radius: 5px; }
        #chat-input { background: #222; border: 1px solid #4a90e2; color: white; padding: 10px; }

        /* Timer */
        #timer { font-size: 2rem; color: #f9d423; font-weight: bold; }

        /* Floating Names (İsim Etiketleri) */
        .player-label { color: white; background: rgba(0,0,0,0.6); padding: 2px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap; pointer-events: none; }

        .player-actions { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: center; gap: 10px; pointer-events: auto; }
        .action-card { background: rgba(30, 30, 60, 0.9); padding: 10px; border-radius: 10px; text-align: center; border: 1px solid #4a90e2; }
        
        button { padding: 8px 12px; cursor: pointer; border-radius: 5px; border: none; font-weight: bold; }
        #vampire-chat-toggle { background: #ff4b5c; margin-top: 5px; display: none; }

        #game-over-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; pointer-events: auto; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="setup" class="hud">
            <h1 style="color:#4ecca3">Vampir Köylü 3D</h1>
            <input type="text" id="nameInp" placeholder="Adın..." style="padding:10px; width:200px;">
            <button onclick="join()" style="background:#4ecca3">KATIL</button>
        </div>

        <div id="top-bar" class="hud" style="display:none;">
            <div id="timer">00</div>
            <div id="role-text" style="font-weight:bold;"></div>
            <div id="status-text">Lobi...</div>
            <button id="start-btn" onclick="start()">OYUNU BAŞLAT</button>
        </div>

        <div id="chat-area" class="hud" style="display:none;">
            <div id="messages"></div>
            <input type="text" id="chat-input" placeholder="Mesaj (Enter)...">
            <button id="vampire-chat-toggle" onclick="toggleVampireChat()">Vampir Chat: KAPALI</button>
        </div>

        <div id="player-actions" class="player-actions"></div>
    </div>

    <div id="game-over-screen">
        <h1 id="winner-text"></h1>
        <p>Lobiye dönülüyor...</p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script>
        let scene, camera, renderer, players3D = {}, labels = [];
        const socket = io();
        let myRole = "", isVampireChat = false;

        function init3D() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050505);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            const table = new THREE.Mesh(new THREE.CylinderGeometry(5, 5, 0.5, 32), new THREE.MeshStandardMaterial({ color: 0x222 }));
            scene.add(table);
            scene.add(new THREE.AmbientLight(0xffffff, 0.5));
            const pLight = new THREE.PointLight(0xffffff, 1, 50);
            pLight.position.set(0, 5, 0);
            scene.add(pLight);

            camera.position.set(0, 7, 10);
            camera.lookAt(0, 0, 0);
            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
            updateLabels();
        }

        // İsim Etiketlerini Güncelle
        function updateLabels() {
            labels.forEach(l => {
                const vector = l.pos.clone().project(camera);
                const x = (vector.x * .5 + .5) * window.innerWidth;
                const y = (-(vector.y * .5) + .5) * window.innerHeight;
                l.el.style.transform = `translate(-50%, -50%) translate(${x}px,${y}px)`;
            });
        }

        function join() {
            const n = document.getElementById('nameInp').value;
            if(n) {
                socket.emit('joinGame', n);
                document.getElementById('setup').style.display = 'none';
                document.getElementById('top-bar').style.display = 'block';
                document.getElementById('chat-area').style.display = 'flex';
                init3D();
            }
        }

        function start() { socket.emit('startGame'); }

        function toggleVampireChat() {
            isVampireChat = !isVampireChat;
            document.getElementById('vampire-chat-toggle').innerText = isVampireChat ? "Vampir Chat: AÇIK" : "Vampir Chat: KAPALI";
        }

        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if(e.key === 'Enter' && e.target.value) {
                socket.emit('sendMessage', { text: e.target.value, type: isVampireChat ? 'vampire' : 'global' });
                e.target.value = '';
            }
        });

        socket.on('assignRole', (role) => {
            myRole = role;
            document.getElementById('role-text').innerText = "ROLÜN: " + role;
            if(role === 'Vampir') document.getElementById('vampire-chat-toggle').style.display = 'block';
            document.getElementById('start-btn').style.display = 'none';
        });

        socket.on('gameUpdate', (data) => {
            document.getElementById('status-text').innerText = data.message;
            // Dinamik Kamera Hareketi
            if(data.state === 'night') {
                camera.position.set(0, 12, 0); // Kuş Bakışı
                camera.lookAt(0,0,0);
            } else {
                camera.position.set(0, 7, 10); // Tartışma Açısı
                camera.lookAt(0,0,0);
            }
            update3DPlayers(data.players);
            updateHUD(data.players, data.state);
        });

        function update3DPlayers(players) {
            players.forEach((p, i) => {
                if(!players3D[p.id]) {
                    const char = new THREE.Mesh(new THREE.CapsuleGeometry(0.4, 0.8, 4, 8), new THREE.MeshStandardMaterial({ color: 0x4a90e2 }));
                    const angle = (i / players.length) * Math.PI * 2;
                    const x = Math.cos(angle)*4, z = Math.sin(angle)*4;
                    char.position.set(x, 0.8, z);
                    scene.add(char);
                    players3D[p.id] = char;

                    // İsim Etiketi Oluştur
                    const el = document.createElement('div');
                    el.className = 'player-label';
                    el.innerText = p.name;
                    document.body.appendChild(el);
                    labels.push({ el, pos: new THREE.Vector3(x, 2, z) });
                }
                if(!p.alive) players3D[p.id].rotation.z = Math.PI/2;
            });
        }

        function updateHUD(players, state) {
            const container = document.getElementById('player-actions');
            container.innerHTML = "";
            players.forEach(p => {
                if(p.alive && p.id !== socket.id) {
                    const card = document.createElement('div');
                    card.className = "action-card";
                    card.innerHTML = `<div>${p.name}</div>`;
                    const btn = document.createElement('button');
                    if(state === 'night') {
                        if(myRole==='Vampir'){ btn.innerText="SALDIR"; btn.onclick=()=>socket.emit('vampireAction', p.id); card.appendChild(btn); }
                        if(myRole==='Doktor'){ btn.innerText="KORU"; btn.onclick=()=>socket.emit('doctorAction', p.id); card.appendChild(btn); }
                        if(myRole==='Kahin'){ btn.innerText="GÖRÜ"; btn.onclick=()=>socket.emit('seerAction', p.id); card.appendChild(btn); }
                    } else if(state === 'day') {
                        btn.innerText="OYLA"; btn.onclick=()=>socket.emit('castVote', p.id); card.appendChild(btn);
                    }
                    container.appendChild(card);
                }
            });
        }

        socket.on('receiveMessage', (d) => {
            const m = document.getElementById('messages');
            m.innerHTML += `<div style="color:${d.color || 'white'}"><b>${d.name}:</b> ${d.text}</div>`;
            m.scrollTop = m.scrollHeight;
        });

        socket.on('timerUpdate', (t) => { document.getElementById('timer').innerText = t; });
        socket.on('gameOver', (d) => { document.getElementById('game-over-screen').style.display='flex'; document.getElementById('winner-text').innerText=d.winner; });
        socket.on('returnToLobby', () => location.reload());
        socket.on('announcement', (m) => alert(m));
    </script>
</body>
</html>